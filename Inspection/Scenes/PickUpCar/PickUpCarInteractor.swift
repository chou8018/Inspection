//
//  PickUpCarInteractor.swift
//  Inspection
//
//  Created by Thanawat prathumset on 4/2/2564 BE.
//  Copyright (c) 2564 BE ___ORGANIZATIONNAME___. All rights reserved.
//
//  This file was generated by the Clean Swift Xcode Templates so
//  you can apply clean architecture to your iOS and Mac projects,
//  see http://clean-swift.com
//

import UIKit

protocol PickUpCarBusinessLogic
{
  func doSomething(request: PickUpCar.Something.Request)
    func setReceiverDateTime(request: PickUpCar.Something.Request, isEdit:Bool)
    func confirmSendDataReceiverCar(request: PickUpCar.Something.Request)
    
    func generatePdfBookIN(request: PickUpCar.Something.Request)
    func validateRequiteField(request: PickUpCar.Something.Request)
    
    func validateActionSendToIMAT(request: PickUpCar.Something.Request)
    func confirmSendToIMAT(request: PickUpCar.Something.Request)
    
    func generateIMATQRCode(request: PickUpCar.Something.Request)
}

protocol PickUpCarDataStore
{
  //var name: String { get set }
    var currentDate: Date? { get set }
    var documentData : Data? { get set }
    var pdfName : String? { get set }
}

class PickUpCarInteractor: PickUpCarBusinessLogic, PickUpCarDataStore
{
  var presenter: PickUpCarPresentationLogic?
  var worker: PickUpCarWorker?
    var pdfWorker : PickUpCarPDFWorker?
    var pdfQRCodeWorker : IMatQRCodePDFWorker?
    var imatWorker : IMatBookInWorker?
    
  //var name: String = ""
    var currentDate: Date?
    var documentData : Data?
    var isBookinNo = false
    
    var pdfName: String?
    var imatInspection : IMatInspectionWorker?
  // MARK: Do something
  
  func doSomething(request: PickUpCar.Something.Request)
  {
//    worker = PickUpCarWorker()
//    worker?.doSomeWork()
//    
//    let response = PickUpCar.Something.Response()
//    presenter?.presentSomething(response: response)
  }
    
    
    func setReceiverDateTime(request: PickUpCar.Something.Request, isEdit:Bool) {
         let date = request.dateReceiver ?? Date()
        
        currentDate = date

        let day = DateFormatter().dateFormat(from: date, dateFormat: "dd-MM-yyyy")
        let time = DateFormatter().dateFormat(from: date, dateFormat: "HH:mm")
        
        let dateTuple = (day , time)
       
        if !isEdit {
            DataController.shared.receiverCarModel.date = date
            DataController.shared.receiverCarModel.dayString = day
            DataController.shared.receiverCarModel.timeString = time
        }
        
        let response = PickUpCar.Something.Response(dayTime: dateTuple)
        presenter?.presentReceiverDayTime(response: response)
       
    }
    
    //MARK: Send TO IMAT
    func validateActionSendToIMAT(request: PickUpCar.Something.Request) {
        let bookinNo = DataController.shared.receiverCarModel.bookinNo
    
        let isEnableSendToIMAP = (bookinNo != nil)//getSendIMATView()
        let isEnableSave = (bookinNo == nil) || isEnableSendToIMAP
        
        let response = PickUpCar.Something.Response(isEnableSendToIMAP: isEnableSendToIMAP,
                                                    isEnableSave: isEnableSave)
        presenter?.presentValidateSendToIMAT(response: response)
    }
    
    func confirmSendToIMAT(request: PickUpCar.Something.Request) {
        print("ðŸ”¸ðŸ¶ confirmSendToIMAT")
        // after send to imat
        // update vihicleId -> BookInType
        // vehicleId = IMAT

        let isEnableSave = getSendIMATView()
        let method  = isEnableSave ? "POST" : "UPDATE"
        switch method {
        case "UPDATE":
            print("{UPDATE}")
            
            imatWorker = IMatBookInWorker()
            imatWorker?.updateIMATBookIn(completion: {[weak self] response in
                if let makeVehicle = response.makeVehicleResponseModel {
                    DataController.shared.receiverCarModel.vehicleId = makeVehicle.vehicleId ?? ""
                }
                
                if let _ = response.error {
                    self?.presenter?.presentSendToIMAT(response: response)
                }else{
                    self?.createPdfBookIN()
                }
                
            })
        case "POST":
            print("{POST}")
            imatWorker = IMatBookInWorker()
            imatWorker?.sendIMAPBookIn(completion: { [weak self] response in
    
                if let makeVehicle = response.makeVehicleResponseModel {
                    DataController.shared.receiverCarModel.vehicleId = makeVehicle.vehicleId ?? ""
                }
    
                if let _ = response.error {
                    self?.presenter?.presentSendToIMAT(response: response)
                }else{
                    self?.createPdfBookIN()
                }
                
                
            })
        default:
            break
        }

        
    }
    var workerPDF : PickUpCarPDFWorker?
    var motorbikeWorker : MotorBikePDFWorker?
    
    fileprivate func createPdfBookIN(){
        let model = DataController.shared.receiverCarModel
        
        switch DataController.shared.bookInType {
       
        case .CAR, .CARWRECK:
            workerPDF = PickUpCarPDFWorker()
            workerPDF?.generatePDFForReceiver(receiverCarModel: model, completion: {
                [weak self] (response) in

                if let documentData = response.documentData ,
                   let image = pdfDataToImage(documentData: documentData) {
                    self?.sendDocumentFile(image)
                }
                
            })
        case .MBIKE, .MBIKEWRECK:
            print("ðŸ›µPDF MOTORBIKE BOOKIN")
            motorbikeWorker = MotorBikePDFWorker()
            motorbikeWorker?.generateMotorBikePDFForBookIn(model: model, completion: { [weak self] response in
                
                if let documentData = response.documentData ,
                   let image = pdfDataToImage(documentData: documentData) {
                    self?.sendDocumentFile(image)
                }
                
            })
        }
        
    }
    
    //MARK: send documentfile
    fileprivate func sendDocumentFile(_ pdfImage: UIImage){
        imatInspection = IMatInspectionWorker()
        imatInspection?.retriveDocument(pdfImage, dType: .BOOKIN, completion: { [weak self] responseDocument in
            
            if let error = responseDocument.error {
                let response = PickUpCar.Something.Response(error : error)
                self?.presenter?.presentSendToIMAT(response: response)
            }else{
                let response = PickUpCar.Something.Response()
                self?.presenter?.presentSendToIMAT(response: response)
            }
        })
        
    }
    
    func confirmSendDataReceiverCar(request: PickUpCar.Something.Request) {
        guard var method =  request.methodReceiver else { return }
        
        method = isBookinNo ? .UPDATE : .POST
        
        let fromEdit = DataController.shared.isFromEditView
        if fromEdit == true { method = .UPDATE }
        
        switch method {
        case .UPDATE:
            print("UPDATE")
            worker = PickUpCarWorker()
            let model = DataController.shared.receiverCarModel

            let bookinNo = DataController.shared.receiverCarModel.bookinNo
            worker?.receiverBookInUpdate(to: bookinNo?.trimWhiteSpace, model: model, completion: {[weak self] (response) in
                if let model = response.receiverModelResponse {
                    self?.isBookinNo = true
                    DataController.shared.receiverCarModel.bookinNo = model.bookinNo
                }
                self?.presenter?.presentReceiverBookIN(response: response)
            })
        case .POST:
            worker = PickUpCarWorker()
            let model = DataController.shared.receiverCarModel
            model.nameReceiver = DataController.shared.getFullName()
            worker?.receiverBookIN(model: model, completion: {[weak self] (response) in
                if let model = response.receiverModelResponse {
                    self?.isBookinNo = true
                    DataController.shared.receiverCarModel.bookinNo = model.bookinNo
                }
                self?.presenter?.presentReceiverBookIN(response: response)
            })
        }
        
    }
    
    func generatePdfBookIN(request: PickUpCar.Something.Request) {
       
        let model = DataController.shared.receiverCarModel
        
        switch DataController.shared.bookInType {
       
        case .CAR, .CARWRECK:
            pdfWorker = PickUpCarPDFWorker()
            pdfWorker?.generatePDFForReceiver(receiverCarModel: model, completion: { [weak self] (response) in
                self?.documentData = response.documentData
                self?.pdfName = createPDFName("BookIn")
                self?.presenter?.presentDPF(response: response)
            })
        case .MBIKE, .MBIKEWRECK:
            print("ðŸ›µPDF MOTORBIKE BOOKIN")
            motorbikeWorker = MotorBikePDFWorker()
            motorbikeWorker?.generateMotorBikePDFForBookIn(model: model, completion: { [weak self] response in
                
                self?.documentData = response.documentData
                self?.pdfName = createPDFName("MotorBikeBookIn")
                self?.presenter?.presentDPF(response: response)
            })
        }
        
    }
    
    //MARK: QRCODE
    func generateIMATQRCode(request: PickUpCar.Something.Request) {
        pdfQRCodeWorker = IMatQRCodePDFWorker()
        let model = DataController.shared.receiverCarModel
        pdfQRCodeWorker?.generateIMATQRCodePDF(receiverCarModel: model, completion: { [weak self] (response) in
            self?.documentData = response.documentData
            self?.pdfName = createPDFName("IMATQR")
            self?.presenter?.presentDPF(response: response)
        })
    }
    
    func validateRequiteField(request: PickUpCar.Something.Request) {
        let model = DataController.shared.receiverCarModel
        
        let senderName = model.nameSender
        let contractNumber = model.contractNumber
        let sellerCode = model.sellerCode
//        let mobileNumber = model.phoneNumber

        let plant = model.plant
        let sellCate = model.sellingCategory

        let makeCar = model.make_BU
        let modelCar = model.modelCar
        let variantsCar = model.variants
        let typeCar = model.body
        let capacityCar = model.engineCapacity
        let yearMake = model.year
        let yearRegister = model.registrationYear
        let registration = model.registration
        let province = model.province
        let colorCar = model.colorCar
        
        let gearbox = model.gearbox
        let fuelType = model.fuelType
        
        let modelCode = model.codeModelCar
        
        let receiverPlace = model.receiverPlace
        let storePlace = model.storePlace
        
        let noteRegistration = model.registrationNote ?? ""
        
        print(receiverPlace)
        print(storePlace)
        
        let validNoteRegistration = noteRegistration.unicodeScalars.count < 99
    
        let validContractNumber = contractNumber != nil && !(contractNumber?.isEmpty ?? false)
        let validSenderName = senderName != nil && !(senderName?.isEmpty ?? false)
//        let validMobile = mobileNumber?.isValidMobile10Digit() ?? false
        let validSellerCode = sellerCode != nil
        
        let validReceiver = receiverPlace != nil && !(receiverPlace?.isEmpty ?? false)
        let validStore = storePlace != nil && !(storePlace?.isEmpty ?? false)
        let validPlant = plant != nil && !(plant?.isEmpty ?? false)
        let validSellCate = sellCate != nil && !(sellCate?.isEmpty ?? false)
        
        let validMake = makeCar != nil && !(makeCar?.isEmpty ?? false)
        let validTypeCar = typeCar != nil && !(typeCar?.isEmpty ?? false)
        let validModelCar = modelCar != nil && !(modelCar?.isEmpty ?? false)
        let validVariantsCar = variantsCar != nil && !(variantsCar?.isEmpty ?? false)
        let validCapacityCar = capacityCar != nil && !(capacityCar?.isEmpty ?? false)
        let validYearMake = yearMake != nil && !(yearMake?.isEmpty ?? false)
        let validYearRegister = yearRegister != nil && !(yearRegister?.isEmpty ?? false)
        let validRegistration = registration != nil && !(registration?.isEmpty ?? false)
        let validProvince = province != nil && !(province?.isEmpty ?? false)
        let validColorCar = colorCar != nil && !(colorCar?.isEmpty ?? false)
        
        let validGearBox = gearbox != nil && !(gearbox?.isEmpty ?? false)
        let validFuelType = fuelType != nil && !(fuelType?.isEmpty ?? false)
        
        let validModelCode = modelCode != nil && !(modelCode?.isEmpty ?? false)
        
        var message : String = ""
        message += validSenderName ? "" : "à¸Šà¸·à¹ˆà¸­à¸œà¸¹à¹‰à¸ªà¹ˆà¸‡ à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡\n"
        message += validContractNumber ? "" : "à¹€à¸¥à¸‚à¸—à¸µà¹ˆà¸ªà¸±à¸à¸à¸² à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡\n"
//        message += validMobile ? "" : "à¸«à¸¡à¸²à¸¢à¹€à¸¥à¸‚à¹‚à¸—à¸£à¸¨à¸±à¸žà¸—à¹Œ à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡\n"
        message += validSellerCode ? "" : "à¸Šà¸·à¹ˆà¸­à¸šà¸£à¸´à¸©à¸±à¸— à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡\n"
        message += validPlant ? "" : "à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆ à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡\n"
        message += validReceiver ? "" : "à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆà¸£à¸±à¸šà¸£à¸– à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡\n"
        message += validStore ? "" : "à¸ªà¸–à¸²à¸™à¸—à¸µà¹ˆà¹€à¸à¹‡à¸šà¸£à¸– à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡\n"
        message += validSellCate ? "" : "sell. category à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡\n"
        message += validModelCode ? "" : "Model Code à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡\n"
        message += validMake ? "" : "à¸¢à¸µà¹ˆà¸«à¹‰à¸­à¸£à¸–à¸¢à¸™à¸•à¹Œ à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡\n"
        message += validTypeCar ? "" : "à¸›à¸£à¸°à¹€à¸ à¸—à¸£à¸–à¸¢à¸™à¸•à¹Œ à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡\n"
        message += validModelCar ? "" : "à¸£à¸¸à¹ˆà¸™à¸£à¸–à¸¢à¸™à¸•à¹Œ à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡\n"
        message += validVariantsCar ? "" : "à¸£à¸¸à¹ˆà¸™à¸¢à¹ˆà¸­à¸¢à¸£à¸–à¸¢à¸™à¸•à¹Œ à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡\n"
        message += validCapacityCar ? "" : "à¸‚à¸™à¸²à¸”à¹€à¸„à¸£à¸·à¹ˆà¸­à¸‡à¸¢à¸™à¸•à¹Œ à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡\n"
        message += validYearMake ? "" : "à¸›à¸µà¸œà¸¥à¸´à¸• à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡\n"
        message += validYearRegister ? "" : "à¸›à¸µà¸ˆà¸”à¸—à¸°à¹€à¸šà¸µà¸¢à¸™ à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡\n"
        message += validRegistration ? "" : "à¸—à¸°à¹€à¸šà¸µà¸¢à¸™ à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡\n"
        message += validProvince ? "" : "à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸” à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡\n"
        message += validColorCar ? "" : "à¸ªà¸µ à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡\n"
        message += validGearBox ? "" : "à¹€à¸à¸µà¸¢à¸£à¹Œ à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡\n"
        message += validFuelType ? "" : "à¸£à¸°à¸šà¸šà¹€à¸Šà¸·à¹‰à¸­à¹€à¸žà¸¥à¸´à¸‡ à¹„à¸¡à¹ˆà¸–à¸¹à¸à¸•à¹‰à¸­à¸‡\n"
        message += validNoteRegistration ? "" : "à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸à¸›à¹‰à¸²à¸¢à¸—à¸°à¹€à¸šà¸µà¸¢à¸™ à¸„à¸§à¸²à¸¡à¸¢à¸²à¸§à¹€à¸à¸´à¸™à¸à¸³à¸«à¸™à¸” 100 à¸•à¸±à¸§à¸­à¸±à¸à¸©à¸£ \n"
        
        
        DataController.shared.receiverCarModel.validReceiver = validReceiver
        DataController.shared.receiverCarModel.validStore = validStore
        DataController.shared.receiverCarModel.validSellCate = validSellCate
        DataController.shared.receiverCarModel.validPlant = validPlant
        DataController.shared.receiverCarModel.validContractNumber = validContractNumber
        DataController.shared.receiverCarModel.validSenderName = validSenderName
//        DataController.shared.receiverCarModel.validMobile = validMobile
        DataController.shared.receiverCarModel.validSellerCode = validSellerCode
        
        DataController.shared.receiverCarModel.validModelCode = validModelCode
        DataController.shared.receiverCarModel.validMake = validMake
        DataController.shared.receiverCarModel.validTypeCar = validTypeCar
        DataController.shared.receiverCarModel.validModelCar = validModelCar
        DataController.shared.receiverCarModel.validVariantsCar = validVariantsCar
        DataController.shared.receiverCarModel.validCapacityCar = validCapacityCar
        DataController.shared.receiverCarModel.validYearMake = validYearMake
        DataController.shared.receiverCarModel.validYearRegister = validYearRegister
        DataController.shared.receiverCarModel.validRegistration = validRegistration
        DataController.shared.receiverCarModel.validProvince = validProvince
        DataController.shared.receiverCarModel.validColorCar = validColorCar
        
        DataController.shared.receiverCarModel.validGearBox = validGearBox
        DataController.shared.receiverCarModel.validFuelType = validFuelType
        DataController.shared.receiverCarModel.validNoteRegistration = validNoteRegistration
        
        NotificationCenter.default.post(name: NSNotification.Name("updateUI"), object: nil)
        
        let validateRequiteFieldError = message.isEmpty ? nil : message
        let response = PickUpCar.Something.Response(validateRequiteFieldError : validateRequiteFieldError)
        
        presenter?.presentRequiteField(response: response)
    }
}
